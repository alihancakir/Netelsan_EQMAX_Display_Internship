#include <stdio.h>
#include <stdbool.h>
#include <unistd.h>
#include <freertos/FreeRTOS.h>
#include "i2c.h"

//REGISTER
#define OSD_GROUP_ADDR		0xB6
#define INDEX_RAM_ADD_H		0x0D
#define INDEX_RAM_ADD_L		0x00

#define INDEX_RAM_DATA_H	0x0E
#define INDEX_RAM_DATA_L	0x01
//-----------------------------
#define FONT_RAM_ADD_H		0x0F
#define FONT_RAM_ADD_L		0x02

#define FONT_RAM_DATA_H		0x03
#define FONT_RAM_DATA_L		0x04

#define QR1_1			0x01C0
#define QR1_2			0x01C1
#define QR1_3			0x01C2
#define QR1_4			0x01C3

#define QR2_1			0x01C4
#define QR2_2			0x01C5
#define QR2_3	  		0x01C6
#define QR2_4			0x01C7

#define QR3_1	   		0x01C8
#define QR3_2	    	0x01C9
#define QR3_3  			0x01CA
#define QR3_4	 		0x01CB




uint8_t QR1_1_BM[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xF0, 0x1F, 0xF0, 0x18, 0x00, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x18, 0x00, 0x1F, 0xF0, 0x1F, 0xF0, 0x00, 0x00
};
uint8_t QR1_2_BM[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE3, 0x30, 0xE3, 0x30, 0x60, 0x00, 0x6F, 0x10, 0x6F, 0x10, 0x6C, 0xE0, 0x6C, 0xE0, 0x6C, 0x60, 0x6C, 0x60, 0x6C, 0x00, 0xEC, 0xD0, 0xEC, 0xD0, 0x0C, 0xC0
};
uint8_t QR1_3_BM[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x70, 0x03, 0x70, 0x6C, 0x60, 0xEF, 0x60, 0x93, 0x60, 0x70, 0x60, 0x70, 0x60, 0x60, 0x60, 0x7C, 0x60, 0x7C, 0x60, 0xB3, 0x70, 0xB3, 0x70, 0x33, 0x00
};
uint8_t QR1_4_BM[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0xFF, 0x80, 0x01, 0x80, 0xFD, 0x80, 0xFD, 0x80, 0xFD, 0x80, 0xFD, 0x80, 0xFD, 0x80, 0xFD, 0x80, 0x01, 0x80, 0xFF, 0x80, 0xFF, 0x80, 0x00, 0x00
};
//---------------------------------------------
uint8_t QR2_1_BM[] = {
  0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xC0, 0x1B, 0xC0, 0x1E, 0x30, 0x1E, 0x30, 0x01, 0xF0, 0x19, 0x00, 0x19, 0x00, 0x1E, 0x10, 0x1E, 0xF0, 0x18, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0x30, 0x1B, 0x30
};
uint8_t QR2_2_BM[] = {
  0xEC, 0xC0, 0xE3, 0xE0, 0x9F, 0xF0, 0x9C, 0xF0, 0x78, 0x70, 0x78, 0x70, 0x9F, 0xF0, 0x7C, 0xC0, 0x7C, 0xC0, 0x8F, 0x10, 0x83, 0x10, 0xF3, 0x00, 0xFF, 0x90, 0x0F, 0x90, 0x63, 0x90, 0x6F, 0x90
};
uint8_t QR2_3_BM[] = {
  0x33, 0x70, 0x70, 0x70, 0xE3, 0x10, 0xE3, 0x10, 0x9F, 0xE0, 0x9D, 0xE0, 0x9D, 0xF0, 0x6D, 0xE0, 0x6D, 0xE0, 0xE3, 0xD0, 0xFF, 0xD0, 0x7F, 0xF0, 0x80, 0x30, 0x80, 0x30, 0xFF, 0xF0, 0xFF, 0xF0
};
uint8_t QR2_4_BM[] = {
  0xF8, 0x00, 0xF8, 0x00, 0x06, 0x00, 0x86, 0x00, 0x77, 0x80, 0x71, 0x80, 0xE1, 0x80, 0x6F, 0x80, 0x6F, 0x80, 0xB6, 0x00, 0xB7, 0x80, 0xF7, 0x80, 0xC1, 0x80, 0xC1, 0x80, 0xCC, 0x00, 0xCC, 0x00
};
//-----------------------------------------------------
uint8_t QR3_1_BM[] = {
0x00, 0x00, 0x1F, 0xF0, 0x1F, 0xF0, 0x18, 0x00, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x1B, 0xF0, 0x18, 0x00, 0x1F, 0xF0, 0x1F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
uint8_t QR3_2_BM[] = {
  0x0F, 0x00, 0xE3, 0x70, 0xE3, 0x70, 0x6C, 0x60, 0x6C, 0x70, 0x6C, 0x70, 0x6C, 0x10, 0x6C, 0xD0, 0x6C, 0xC0, 0x6C, 0xF0, 0x60, 0xF0, 0xEC, 0x70, 0xEC, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
uint8_t QR3_3_BM[] = {
  0x37, 0x00, 0xB7, 0x60, 0xB7, 0x60, 0x07, 0x00, 0xFF, 0xF0, 0xFF, 0xF0, 0xBD, 0xE0, 0xBD, 0xE0, 0x42, 0x00, 0x4E, 0x00, 0x0F, 0xF0, 0xE1, 0xF0, 0xE1, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
uint8_t QR3_4_BM[] = {
  0xF0, 0x00, 0xCF, 0x80, 0xCF, 0x80, 0xF1, 0x80, 0xFD, 0x80, 0xCC, 0x00, 0xCF, 0x80, 0xFF, 0x80, 0x3D, 0x80, 0x3D, 0x80, 0xF1, 0x80, 0xFF, 0x80, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};



void load_costum_font_ram(unsigned char position, unsigned char *font) 
{    
	uint8_t i,adr=position*16;
	write_byte(OSD_GROUP_ADDR, FONT_RAM_ADD_H, 0x00);
	for(i=0 ; i<16 ;i++)
	{		
	    write_byte(OSD_GROUP_ADDR, FONT_RAM_ADD_L, adr+i);           
	    write_byte(OSD_GROUP_ADDR, FONT_RAM_DATA_L, *font++); 
	    write_byte(OSD_GROUP_ADDR, FONT_RAM_DATA_H, *font++);   
	}		
}

void show_custom_font_ram(unsigned char position, uint16_t font){
	
	write_byte(0xB6, 0x32, 0x0F);  // coef
	
	write_byte(0xB6, 0x2B, 0xFF);  // vertical
	write_byte(0xB6, 0x2C, 0xFF);  // vertical
	write_byte(0xB6, 0x2D, 0xFF);  // vertical
	write_byte(0xB6, 0x2E, 0xFF);  // vertical
	//write_byte(0xB6, 0x32, 0x0A);  // coef
	write_byte(0xB6, 0x2F, 0xFF);  // horizontal
	write_byte(0xB6, 0x30, 0xFF);  // horizontal
	write_byte(0xB6, 0x31, 0xFF);  // horizontal

	
	write_byte(OSD_GROUP_ADDR, 0x76, 0x0C);//x
	write_byte(OSD_GROUP_ADDR, 0x77, 0x10);//y
	write_byte(OSD_GROUP_ADDR,INDEX_RAM_ADD_H,0x00); //sub addr =0x17: block1 start address
    write_byte(OSD_GROUP_ADDR,INDEX_RAM_ADD_L,position);
    write_byte(OSD_GROUP_ADDR,INDEX_RAM_DATA_H,(font>>8));
    write_byte(OSD_GROUP_ADDR,INDEX_RAM_DATA_L,font);
}

void app_main(void)
{
	printf("device started....waiting for connect.\n");
//---------------------------------------------------------------
	vTaskDelay(pdMS_TO_TICKS(2000));						//Waiting for wake up display
	i2c_init();															//Initialize i2c		
	connect_display();													//Connect to AMT630A
	printf("connected the AMT630A.\n");
//---------------------------------------------------------------			
	write_byte(0xB6, 0x05,0x01);		//OSD block0  state----------------------open
	write_byte(0xB6, 0x05,0x61);  		//user color select----------------------enable
	write_byte(0xB6, 0x06,0x61);		//OSD mix state--------------------------enable
	write_byte(0xB6, 0x06,0x70);		//OSD mix mode together------------------open
	write_byte(0xB4, 0xD2,0x14);  		//Video color select---------------------red----4F: no color back video, 0x14: black
	printf("display configuration done.\n");
//---------------------------------------------------------------
	write_byte(0xB6, 0x07,0x04);		//OSD block0  x_size---------------------0x01: 1 block horizontal-----------------------------0x0B: 11 blocks horizontaL---HEXADECIMAL!
	write_byte(0xB6, 0x08,0x03);		//OSD block0  y_size---------------------0x01: 1 block vertical-------------------------------0x08: 8 blocks vertical------HEXADECIMAL!
	write_byte(0xB6, 0x0A,0x92);  		//OSD block0  x_position-----------------show block x_position:first 0x19,second 0x27,third 0x035-----value:(0x19+(PCS*(0x16/2))) 
	write_byte(0xB6, 0x0B,0x17);  		//OSD block0  y_position-----------------show block y_position:first 0x06,second 0x17,third 0x028-----value:(0x06+(PCS*(0x22/2)))                                             
	write_byte(0xB6, 0x2A,0x60);  		//OSD block color select-----------------white
    write_byte(0xB6, 0x09,0x00);  		//OSD block0  x_position Multiplier------0x01:OSD block 0 x_size+256px: The second size of display,0x00:disable multiplier
    printf("OSD QR code block0 done.\n");
//---------------------------------------------------------------
	
	load_costum_font_ram(0, QR1_1_BM);
	show_custom_font_ram(0,QR1_1);
	
	load_costum_font_ram(1, QR1_2_BM);
	show_custom_font_ram(1,QR1_2);
	
	load_costum_font_ram(2, QR1_3_BM);
	show_custom_font_ram(2,QR1_3);
	
	load_costum_font_ram(3, QR1_4_BM);
	show_custom_font_ram(3,QR1_4);

//------------------------------------------------------------------
	load_costum_font_ram(4, QR2_1_BM);
	show_custom_font_ram(4,QR2_1);
	
	load_costum_font_ram(5, QR2_2_BM);
	show_custom_font_ram(5,QR2_2);
	
	load_costum_font_ram(6, QR2_3_BM);
	show_custom_font_ram(6,QR2_3);
	
	load_costum_font_ram(7, QR2_4_BM);
	show_custom_font_ram(7,QR2_4);
//------------------------------------------------------------------
	load_costum_font_ram(8, QR3_1_BM);
	show_custom_font_ram(8,QR3_1);
	
	load_costum_font_ram(9, QR3_2_BM);
	show_custom_font_ram(9,QR3_2);
	
	load_costum_font_ram(10, QR3_3_BM);
	show_custom_font_ram(10,QR3_3);
	
	load_costum_font_ram(11, QR3_4_BM);
	show_custom_font_ram(11,QR3_4);

	printf("block0 char test.\n");

}

